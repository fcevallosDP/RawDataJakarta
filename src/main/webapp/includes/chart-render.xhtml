<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui">

    <div class="chart-container" style="text-align:center; padding: 1rem;">
        <canvas id="#{canvasId}"
                data-labels="#{labelsJson}"
                data-valores="#{valoresJson}"
                data-charttitle="#{chartTitle}"
                width="600" height="300"
                style="display: block; margin: 0 auto; border: 2px solid red; max-height: 400px; box-sizing: border-box;"></canvas>

        <div class="chart-title" style="color: red; font-weight: bold;">
            ID: #{canvasId}
        </div>
    </div>

    <h:outputScript>
    //<![CDATA[
    (function () {
        const canvasId = "#{canvasId}";
        const fnName = "drawChart_" + canvasId;

        console.log("✅ Registrando drawChart para:", canvasId);

        window[fnName] = function () {
            console.log("🟦 Intentando renderizar:", canvasId);
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn("⚠️ No se encontró canvas con ID:", canvasId);
                return;
            }

            const labels = JSON.parse(canvas.dataset.labels || "[]");
            const valores = JSON.parse(canvas.dataset.valores || "[]");
            const chartTitle = canvas.dataset.charttitle || "";

            if (window["chart_" + canvasId] instanceof Chart) {
                window["chart_" + canvasId].destroy();
            }

            window["chart_" + canvasId] = new Chart(canvas.getContext("2d"), {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartTitle,
                        data: valores,
                        backgroundColor: "rgba(153, 102, 255, 0.5)",
                        borderColor: "rgba(153, 102, 255, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        datalabels: {
                            anchor: "end",
                            align: "top",
                            formatter: Math.round
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        };

        window.chartInitFns = window.chartInitFns || [];
        window.chartInitFns.push(window[fnName]);
    })();
    //]]>
    </h:outputScript>
</ui:composition>
