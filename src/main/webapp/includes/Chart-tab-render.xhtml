<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui">

    <div style="overflow-y: auto; max-height: 500px;">
        <canvas id="#{canvasId}"
                data-labels="#{labelsJson}"
                data-valores="#{valoresJson}"
                data-charttitle="#{chartTitle}"
                style="width: 100%; display: block; margin: 0 auto; max-height: 400px; box-sizing: border-box; border: 1px solid #dee2e6;"></canvas>
        <div class="chart-title" style="font-weight: bold;">#{chartTitle}</div>
    </div>

<h:outputScript target="body">
    //<![CDATA[
    window.chartInitFns = window.chartInitFns || [];

    window.chartInitFns.push(function drawChart_#{canvasId}() {
        console.log("⏳ Intentando renderizar: #{canvasId}");

        const canvas = document.getElementById("#{canvasId}");
        if (!canvas) {
            console.warn("❌ Canvas no disponible para #{canvasId}");
            return;
        }

        let labels = [], valores = [];
        try {
            labels = JSON.parse(canvas.dataset.labels || "[]");
            valores = JSON.parse(canvas.dataset.valores || "[]");
        } catch (e) {
            console.error("❌ Error al parsear datos para #{canvasId}", e);
            return;
        }

        const chartKey = "chart_#{canvasId}";
        if (window[chartKey] instanceof Chart) {
            window[chartKey].destroy(); // 💥 Destruir el gráfico anterior si existe
        }

        window[chartKey] = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: valores,
                    backgroundColor: 'rgba(153, 102, 255, 0.5)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1,
                    barThickness: 30
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        font: { weight: 'bold', size: 12 }
                    }
                },
                scales: {
                    x: { beginAtZero: true },
                    y: { beginAtZero: true }
                }
            },
            plugins: [ChartDataLabels]
        });

        console.log("✅ Renderizado: #{canvasId}");
    });
    //]]>
</h:outputScript>

</ui:composition>
