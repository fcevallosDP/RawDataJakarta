<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui">

    <div style="text-align:center; padding: 1rem;">
        <h4 style="font-size: 1.2rem;font-weight: bold;margin-bottom: 0.5rem;box-sizing: border-box; border: 1px solid #dee2e6; color: #0b07f0">#{goalType}</h4>
        <canvas id="#{canvasId}"
                data-labels="#{labelsJson}"
                data-valores="#{valoresJson}"
                data-charttitle="#{chartTitle}"
                data-colores="#{coloresJson}"
                data-goal="#{goalJson}"
                style="width: 100%; display: block; margin: 0 auto; max-height: 400px; box-sizing: border-box; border: 1px solid #dee2e6;">
        </canvas>

        <div class="chart-title" style="font-weight: bold; color: #0b07f0">#{chartTitle}</div>
    </div>

    <h:outputScript>
    //<![CDATA[
    (function () {
        const canvasId = "#{canvasId}";
        const fnName = "drawChart_" + canvasId;

        console.log("âœ… Registrando drawChart para:", canvasId);

        window[fnName] = function () {
            console.log("ðŸŸ¦ Intentando renderizar:", canvasId);
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn("âš ï¸ No se encontrÃ³ canvas con ID:", canvasId);
                return;
            }

            const labels = JSON.parse(canvas.dataset.labels || "[]");
            const valores = JSON.parse(canvas.dataset.valores || "[]").map(v => Math.round(parseFloat(v) * 100) / 100);
            const colores = JSON.parse(canvas.dataset.colores || "[]");
            const chartTitle = canvas.dataset.charttitle || "";
            const goal = parseFloat(canvas.dataset.goal || "0");          

            if (window["chart_" + canvasId] instanceof Chart) {
                window["chart_" + canvasId].destroy();
            }

            window["chart_" + canvasId] = new Chart(canvas.getContext("2d"), {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        data: valores,
                        backgroundColor: colores,
                        borderColor: "rgba(153, 102, 255, 1)",
                        borderWidth: 1
                    }]
                },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRadio: 2,
                        indexAxis: 'x',
                        scales: {
                            x: {
                                barPercentage: 0.2,
                                categoryPercentage: 0.4,
                                ticks: { autoSkip: false },
                                grid: { display: true }
                            },
                            y: { beginAtZero: true,
                                grace: 0.5
                            }
                        },
                        plugins: {
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                color: '#000',
                                font: { weight: 'bold', size: 11 }
                            },
                            legend: {
                                display: false
                            },
                            title: {
                                display: false,
                                text: chartTitle
                            },
                            tooltip: { enabled: false},
                            annotation: {
                                    annotations: {
                                        goalLine: {
                                            type: 'line',
                                            yMin: goal,
                                            yMax: goal,
                                            borderColor: '#0b07f0',
                                            borderWidth: 1,
                                            borderDash: [3 ,3],
                                            label: {
                                                display: false,
                                                content: 'Goal',
                                                position: 'end',
                                                color: '#0b07f0',
                                                font: { style: 'italic', size: 10 },
                                                backgroundColor: 'rgba(255,255,255,0.7)'
                                            }
                                        }
                                    }
                                }
                            
                        }
                    },
                plugins: [ChartDataLabels]
            });
        };

        window.chartInitFns = window.chartInitFns || [];
        window.chartInitFns.push(window[fnName]);
    })();
    //]]>
    </h:outputScript>
</ui:composition>
